<?xml version="1.0" encoding="UTF-8"?>
<project name="TYPO3CMS.Package.Configuration">
	<target name="create-from-template">
		<if>
			<not>
				<available file="./LocalConfiguration.properties" />
			</not>
			<then>
				<move file="./LocalConfiguration.dist.properties" tofile="./LocalConfiguration.properties" />

				<append destFile="./LocalConfiguration.properties">
					<filterchain>
						<filterreader classname="Filters.LocalConfigurationFilter">
							<param name="TYPO3Version" value="${typo3.cms.version}" />
						</filterreader>
					</filterchain>

					<fileset dir="${typo3.cms.defaultConfigurationDirectory}">
						<include name="${typo3.cms.defaultConfigurationFile}" />
					</fileset>
				</append>

				<property name="firstTimeLocalConfiguration" value="true" />

				<echo>LocalConfiguration.properties successfully generated.</echo>
			</then>
			<else>
				<property name="firstTimeLocalConfiguration" value="false" />

				<echo>LocalConfiguration.properties already generated.</echo>
			</else>
		</if>

		<!-- load properties -->
		<property file="./LocalConfiguration.properties" prefix="LocalConfiguration" />

		<if>
			<istrue value="${firstTimeLocalConfiguration}" />
			<then>
				<input propertyName="skipDeployment" validArgs="Y,N">This is the first time the LocalConfiguration.properties is generated. Skip deployment to do manual adjustments?</input>
			</then>
		</if>

		<fail if="skipDeployment" message="Deployment skipped. Please adjust the LocalConfiguration.properties suiting your needs and re-run deployment." />
	</target>

	<target name="merge-with-remote">
		<echo>WIP: merging local configuration with remote configuration.</echo>
	</target>

	<target name="generate" depends="merge-with-remote">
		<taskdef classname="Tasks.LocalConfigurationGenerator" name="localconfigurationgenerator" />

		<localconfigurationgenerator file="../www/typo3conf/LocalConfiguration.php" propertyprefix="LocalConfiguration" />
	</target>

	<target name="run" depends="create-from-template, generate">
		<echo>LocalConfiguration.php was successfully generated.</echo>
	</target>
</project>