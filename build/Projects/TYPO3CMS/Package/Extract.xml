<?xml version="1.0" encoding="UTF-8"?>
<project name="TYPO3CMS.Package.Extract">

	<target name="typo3cms:package:extract:prepare">
		<mktempdir prefix="t3e" property="package.extraction.dir" />
		<echo>Successfully created temporary extraction directory: ${package.extraction.dir}</echo>

		<condition property="isTarArchive">
			<or>
				<equals arg1="${typo3.cms.format}" arg2="" />
				<equals arg1="${typo3.cms.format}" arg2="tar" />
			</or>
		</condition>

		<condition property="isZipArchive">
			<equals arg1="${typo3.cms.format}" arg2="zip" />
		</condition>

		<if>
			<not>
				<or>
					<isset property="isTarArchive" />
					<isset property="isZipArchive" />
				</or>
			</not>
			<then>
				<fail message="The specified format (${typo3.cms.format}) is not supported!" />
			</then>
		</if>
	</target>

	<target name="typo3cms:package:extract:tar" if="isTarArchive">
		<!--
		<property
			name="command"
			value="tar xzf ${build.cache.package} - -strip-components=1 - -directory ../www/" />

		<exec command="${command}" checkreturn="true" />
		-->

		<untar file="${build.cache.package}" todir="${package.extraction.dir}" />
	</target>

	<target name="typo3cms:package:extract:zip" if="isZipArchive">
		<!--
			@see http://superuser.com/a/573624
			temp=$(mktemp -d) && unzip -d "$temp" ${build.cache.package} && mv "$temp"/*/* ../www/ && rmdir "$temp"/* "$temp"
		-->
		<!--
		<property
			name="command"
			value="temp=$(mktemp -d) &amp;&amp; unzip -d &quot;$temp&quot; ${build.cache.package} &amp;&amp; mv &quot;$temp&quot;/*/* ../www/ &amp;&amp; rmdir &quot;$temp&quot;/* &quot;$temp&quot;" />

		<exec command="${command}" checkreturn="true" />
		-->

		<unzip file="${build.cache.package}" todir="${package.extraction.dir}" />
	</target>

	<target name="typo3cms:package:extract:run" depends="project:cleanup, typo3cms:package:extract:prepare, typo3cms:package:extract:tar, typo3cms:package:extract:zip">
		<move todir="../www">
			<fileset dir="${package.extraction.dir}">
				<include name="**/**" />
			</fileset>
			<!-- from is set to "dirs" internally -->
			<!--
			<mapper classname="Mappers.CutDirsMapper" from="1" />
			-->
			<!--
				starting point of file name is ${package.extraction.dir}

				Example

				Given ${package.extraction.dir} is /tmp/t3e123456

				Result
				String passed to $from pattern is "blankpackage-6.0.7/typo3conf/LocalConfiguration.php"
			-->
			<mapper type="regexp" from="^(.[^/]*)/(.*)" to="\2" />
		</move>

		<delete dir="${package.extraction.dir}" />

		<echo>The TYPO3 CMS Package was successfully extracted.</echo>
	</target>
</project>