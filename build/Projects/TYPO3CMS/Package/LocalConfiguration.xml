<?xml version="1.0" encoding="UTF-8"?>
<project name="TYPO3CMS.Package.LocalConfiguration">

	<target name="create-from-default">
		<if>
			<not>
				<available file="./Properties/LocalConfiguration.properties" />
			</not>
			<then>
				<move file="./Properties/LocalConfiguration.dist.properties" tofile="./Properties/LocalConfiguration.properties" />

				<append destFile="./Properties/LocalConfiguration.properties">
					<filterchain>
						<filterreader classname="Filters.LocalConfigurationFilter">
							<param name="TYPO3Version" value="${typo3.cms.version}" />
						</filterreader>
					</filterchain>

					<fileset dir="${typo3.cms.defaultConfigurationDirectory}">
						<include name="${typo3.cms.defaultConfigurationFile}" />
					</fileset>
				</append>

				<property name="firstTimeLocalConfiguration" value="true" />

				<echo>LocalConfiguration.properties successfully generated.</echo>
			</then>
			<else>
				<property name="firstTimeLocalConfiguration" value="false" />

				<echo>LocalConfiguration.properties already generated.</echo>
			</else>
		</if>

		<!-- load properties -->
		<property file="./Properties/LocalConfiguration.properties" prefix="LocalConfiguration" />

		<if>
			<istrue value="${firstTimeLocalConfiguration}" />
			<then>
				<echo>This is the first time the LocalConfiguration.properties is generated.</echo>
				<input propertyName="skipDeployment" validArgs="Y,N" defaultValue="Y">Skip deployment to do manual adjustments?</input>
			</then>
		</if>

		<if>
			<equals arg1="${skipDeployment}" arg2="Y" />
			<then>
				<fail message="Deployment skipped. Please adjust the LocalConfiguration.properties suiting your needs and re-run deployment." />
			</then>
		</if>
	</target>

	<target name="generate">
		<taskdef classname="Tasks.GenerateLocalConfigurationTask" name="generatelocalconfiguration" />

		<generatelocalconfiguration file="../www/typo3conf/LocalConfiguration.php" propertyprefix="LocalConfiguration" />
	</target>

	<target name="merge-with-remote" depends="generate">
		<!-- download remote LocalConfiguration file -->
		<if>
			<and>
				<equals arg1="${target.protocol}" arg2="ftp" />
				<not>
					<available file="${build.cache.dir}/LocalConfiguration.php" />
				</not>
			</and>
			<then>
				<echo>The remote LocalConfiguration.php can only be downloaded via `scp`.</echo>
				<echo>Set the `protocol` property of target `${deployTo}` to `scp` or download the file manually into `${build.cache.dir}`.</echo>
				<fail message="Cannot proceed with LocalConfiguration.php merging. Follow the instructions above and re-run deployment." />
			</then>
			<else>
				<scp username="${target.username}" password="${target.password}" host="${target.hostname}" port="${target.port}" fetch="true" todir="${build.cache.dir}" file="${target.path}/typo3conf/LocalConfiguration.php" />
			</else>
		</if>

		<taskdef classname="Tasks.MergeLocalConfigurationTask" name="mergelocalconfiguration" />

		<mergelocalconfiguration localfile="../www/typo3conf/LocalConfiguration.php" remotefile="${build.cache.dir}/LocalConfiguration.php" />
	</target>

	<target name="run" depends="create-from-default, merge-with-remote">
		<echo>LocalConfiguration.php was successfully generated.</echo>
	</target>
</project>